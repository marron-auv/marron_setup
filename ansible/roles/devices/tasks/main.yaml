---
- name: Copy rule file
  become: true
  ansible.builtin.copy:
    src: 99-marron-devices.rules
    dest: /etc/udev/rules.d/99-marron-devices.rules
    backup: true

- name: Update udev rule
  become: true
  shell: udevadm trigger

- name: Append the group 'docker' to the user's groups
  become: true
  ansible.builtin.user:
    name: "{{ ansible_user }}"
    groups: [docker]
    append: yes

- name: Restart docker
  become: true
  shell: service docker restart

- name: Stop and remove marron container
  shell: docker stop marron && docker rm marron
  ignore_errors: true

- name: Pull docker image
  shell: docker pull hakuturu583/marron:latest

- name: Start docker container
  shell:
    cmd: >
      docker run -d --name marron --restart always --net=host
      --device=/dev/motor_teensy:/dev/motor_teensy
      --device=/dev/imu:/dev/imu
      hakuturu583/marron:latest
      ros2 launch marron_driver driver.launch.xml
